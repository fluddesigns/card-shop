{% extends "base.html" %}

{% block title %}Inventory - {{ owner.username }}{% endblock %}

{% block styles %}
<style>
    .shop-header { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 2rem 1rem; text-align: center; border-radius: 0 0 15px 15px; margin-bottom: 2rem; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
    .contact-badge { background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 20px; display: inline-block; margin-top: 10px; backdrop-filter: blur(5px); }
    
    .view-toggle .btn-check:checked + .btn-outline-primary { background-color: #1e3c72; border-color: #1e3c72; color: white; }

    .binder-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
    .card-slot { border: none; border-radius: 10px; overflow: hidden; background: #2c3e50; position: relative; aspect-ratio: 2.5/3.5; transition: transform 0.2s; cursor: pointer; }
    .card-slot:hover { transform: translateY(-5px); z-index: 10; box-shadow: 0 8px 15px rgba(0,0,0,0.3); }
    
    .card-image { width: 100%; height: 100%; object-fit: contain; position: relative; z-index: 1; transition: opacity 0.3s; opacity: 0; }
    .card-image.loaded { opacity: 1; }
    
    .skeleton-loader { width: 100%; height: 100%; background: linear-gradient(90deg, #34495e 25%, #2c3e50 50%, #34495e 75%); background-size: 200% 100%; animation: loading 1.5s infinite; position: absolute; top: 0; left: 0; z-index: 2; }
    .skeleton-loader.hidden { display: none; }
    
    @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    .price-badge { position: absolute; top: 8px; right: 8px; background: #27ae60; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; z-index: 5; }
    .info-overlay { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.85); color: white; padding: 5px; font-size: 0.75rem; text-align: center; z-index: 5; }
    
    .filter-bar { background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 20px; border: 1px solid #dee2e6; }
    .filter-label { font-size: 0.75rem; font-weight: bold; color: #6c757d; text-transform: uppercase; margin-bottom: 4px; }
</style>
{% endblock %}

{% block content %}
<!-- Define Critical Handlers Early -->
<script>
    function imageLoaded(id) {
        const loader = document.getElementById('loader-' + id);
        const img = document.getElementById('img-' + id);
        if (loader) loader.classList.add('hidden');
        if (img) img.classList.add('loaded');
    }
    function imageFailed(img, id) { img.classList.add('needs-fetch'); }
</script>

<div class="shop-header text-center">
    <h1 class="fw-bold">{{ owner.username|capitalize }}'s Collection</h1>
    <p class="mb-0 opacity-75">Browse available singles.</p>
    <div class="contact-badge"><a href="m.me/fludblake">👋 Click here to message me</a></div>
    <!-- <div class="contact-badge">👋 {{ contact_info }}</div> -->
</div>

<div class="container-fluid px-3">
    
    <!-- UNIFIED FILTER BAR -->
    <div class="filter-bar shadow-sm">
        <div class="row g-2 align-items-end">
            <div class="col-md-3">
                <label class="filter-label">Search</label>
                <input type="text" id="searchInput" class="form-control form-control-sm" placeholder="Search by name...">
            </div>
            <div class="col-6 col-md-2">
                <label class="filter-label">Sort By</label>
                <select id="sortGrid" class="form-select form-select-sm">
                    <option value="price-desc" selected>Price: High to Low</option>
                    <option value="price-asc">Price: Low to High</option>
                    <option value="name-asc">Name: A to Z</option>
                    <option value="set-asc">Set: A to Z</option>
                </select>
            </div>
            <div class="col-6 col-md-2">
                <label class="filter-label">Game</label>
                <select id="filterGame" class="form-select form-select-sm"><option value="">All Games</option></select>
            </div>
            <div class="col-6 col-md-2">
                <label class="filter-label">Set</label>
                <select id="filterSet" class="form-select form-select-sm"><option value="">All Sets</option></select>
            </div>
            <div class="col-6 col-md-3">
                <div class="d-flex justify-content-end align-items-end h-100">
                    <div class="btn-group view-toggle" role="group">
                        <input type="radio" class="btn-check" name="viewmode" id="v-grid" checked onchange="toggleView('grid')">
                        <label class="btn btn-sm btn-outline-primary" for="v-grid">🖼️ Grid</label>
                        <input type="radio" class="btn-check" name="viewmode" id="v-list" onchange="toggleView('list')">
                        <label class="btn btn-sm btn-outline-primary" for="v-list">📋 List</label>
                    </div>
                </div>
            </div>
        </div>
        <div class="mt-2 text-muted small text-end">
            Showing <span id="visibleCount" class="fw-bold">{{ inventory|length }}</span> cards
        </div>
    </div>

    <!-- GRID -->
    <div id="view-grid" class="binder-grid">
        {% for card in inventory %}
        <div class="card-slot card-item" 
             data-game="{{ card.game }}" 
             data-name="{{ card.card_name }}" 
             data-set="{{ card.set_name }}"
             data-finish="{{ card.finish }}"
             data-condition="{{ card.condition }}"
             data-price="{{ card.price }}">
            
            {% if show_prices %}
            <div class="price-badge">${{ "%.2f"|format(card.price) }}</div>
            {% endif %}

            <div class="skeleton-loader" id="loader-{{ card.id }}"></div>

            <img class="card-image {% if not card.image_url %}needs-fetch{% endif %}" 
                 id="img-{{ card.id }}"
                 src="{{ card.image_url if card.image_url else '' }}" 
                 alt="{{ card.card_name }}" 
                 loading="lazy"
                 onload="imageLoaded('{{ card.id }}')"
                 onerror="imageFailed(this, '{{ card.id }}')">
            
            <div class="info-overlay">
                <div class="text-truncate fw-bold">{{ card.card_name }}</div>
                <div class="opacity-75">{{ card.set_name }} • {{ card.condition }}</div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- LIST -->
    <div id="view-list" class="d-none">
        <div class="card shadow-sm">
            <div class="card-body p-0">
                <table id="inventoryTable" class="table table-striped table-hover mb-0 w-100">
                    <thead><tr><th>Name</th><th>Set</th><th>Game</th><th>Finish</th><th>Cond</th>{% if show_prices %}<th>Price</th>{% endif %}<th>Qty</th></tr></thead>
                    <tbody>
                        {% for card in inventory %}
                        <tr>
                            <td class="fw-bold">{{ card.card_name }}</td>
                            <td>{{ card.set_name }}</td>
                            <td>{{ card.game }}</td>
                            <td>{{ card.finish }}</td>
                            <td><span class="badge bg-secondary">{{ card.condition }}</span></td>
                            {% if show_prices %}<td class="text-success fw-bold">${{ "%.2f"|format(card.price) }}</td>{% endif %}
                            <td>{{ card.quantity }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.4.1/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.4.1/js/responsive.bootstrap5.min.js"></script>
<script>
    let dataTable;

    function toggleView(mode) {
        if(mode === 'grid') {
            $('#view-grid').removeClass('d-none');
            $('#view-list').addClass('d-none');
        } else {
            $('#view-grid').addClass('d-none');
            $('#view-list').removeClass('d-none');
            if(dataTable) dataTable.columns.adjust().responsive.recalc();
        }
    }

    $(document).ready(function () {
        dataTable = $('#inventoryTable').DataTable({
            responsive: true,
            pageLength: 50,
            dom: 't', 
            paging: false, 
            order: [[5, 'desc']], // Column 5 is Price if visible
            columnDefs: [
                { responsivePriority: 1, targets: 0 }, 
                { responsivePriority: 2, targets: -2 }
            ]
        });

        // POPULATE DROPDOWNS
        const games = new Set();
        const sets = new Set();
        $('.card-item').each(function() {
            games.add($(this).data('game'));
            sets.add($(this).data('set'));
        });
        populateSelect('#filterGame', games);
        populateSelect('#filterSet', sets);

        function populateSelect(selector, set) {
            Array.from(set).filter(Boolean).sort().forEach(val => {
                $(selector).append(new Option(val, val));
            });
        }

        // FILTER EVENT
        $('#searchInput, #filterGame, #filterSet').on('keyup change', function() {
            filterAll();
        });

        // SORT EVENT
        $('#sortGrid').on('change', function() {
            const sortType = $(this).val();
            const $grid = $('#view-grid');
            const $cards = $grid.children('.card-slot');

            $cards.sort(function(a, b) {
                let valA, valB;
                switch(sortType) {
                    case 'price-desc':
                        return (parseFloat($(b).data('price')) || 0) - (parseFloat($(a).data('price')) || 0);
                    case 'price-asc':
                        return (parseFloat($(a).data('price')) || 0) - (parseFloat($(b).data('price')) || 0);
                    case 'name-asc':
                        return $(a).data('name').localeCompare($(b).data('name'));
                    case 'set-asc':
                        return $(a).data('set').localeCompare($(b).data('set'));
                    default: return 0;
                }
            });
            $cards.detach().appendTo($grid);
        });

        function filterAll() {
            const search = $('#searchInput').val().toLowerCase();
            const game = $('#filterGame').val();
            const set = $('#filterSet').val();
            let visibleCount = 0;

            $('.card-item').each(function() {
                const $el = $(this);
                const matchesSearch = $el.data('name').toLowerCase().includes(search);
                const matchesGame = !game || $el.data('game') === game;
                const matchesSet = !set || $el.data('set') === set;

                if (matchesSearch && matchesGame && matchesSet) {
                    $el.show();
                    visibleCount++;
                } else {
                    $el.hide();
                }
            });

            dataTable.search(search).draw();
            dataTable.column(2).search(game ? '^'+$.fn.dataTable.util.escapeRegex(game)+'$' : '', true, false).draw();
            dataTable.column(1).search(set ? '^'+$.fn.dataTable.util.escapeRegex(set)+'$' : '', true, false).draw();
            
            $('#visibleCount').text(visibleCount);
        }
    });

    // --- API FALLBACK QUEUE (Slow/Safe) ---
    document.addEventListener("DOMContentLoaded", function() {
        const queue = Array.from(document.querySelectorAll('img.needs-fetch'));
        const RATE_LIMIT_DELAY = 150; 
        processNext();
        function processNext() {
            if (queue.length === 0) return;
            const img = queue.shift();
            const cardSlot = img.closest('.card-slot');
            if (cardSlot) {
                fetchCardImage(cardSlot, img).finally(() => { setTimeout(processNext, RATE_LIMIT_DELAY); });
            } else { processNext(); }
        }
        async function fetchCardImage(card, imgEl) {
            const game = (card.dataset.game || "").toLowerCase();
            const name = card.dataset.name;
            const set = (card.dataset.set || "").trim();

            try {
                if (game.includes('magic') || game.includes('mtg')) {
                    let query = `https://api.scryfall.com/cards/search?q=name:"${encodeURIComponent(name)}"`;
                    if (set) query += `+set:"${encodeURIComponent(set)}"`;
                    let r = await fetch(query);
                    if (!r.ok) r = await fetch(`https://api.scryfall.com/cards/named?fuzzy=${encodeURIComponent(name)}`);
                    if(!r.ok) throw new Error("404");
                    const d = await r.json();
                    let target = d.data && d.data.length > 0 ? d.data[0] : d;
                    if (target.image_uris) applySrc(imgEl, target.image_uris.normal);
                    else if (target.card_faces) applySrc(imgEl, target.card_faces[0].image_uris.normal);
                    else throw new Error("No Img");
                } 
                else if (game.includes('pokemon') || game.includes('pkmn')) {
                    const cleanName = name.split('(')[0].trim();
                    let query = `https://api.pokemontcg.io/v2/cards?q=name:"${encodeURIComponent(cleanName)}"`;
                    if (set) query += ` set.name:"${encodeURIComponent(set)}"`;
                    let r = await fetch(query);
                    let d = await r.json();
                    if (!d.data || d.data.length === 0) { r = await fetch(`https://api.pokemontcg.io/v2/cards?q=name:"${encodeURIComponent(cleanName)}"`); d = await r.json(); }
                    if (d.data && d.data.length > 0) applySrc(imgEl, d.data[0].images.small);
                    else throw new Error("No Img");
                } 
                else { loadFallback(imgEl, 'default'); }
            } catch (error) { loadFallback(imgEl, game.includes('pokemon') ? 'pokemon' : 'default'); }
        }
        function applySrc(img, src) { img.src = src; }
        function loadFallback(img, type) {
            let backSrc = "https://upload.wikimedia.org/wikipedia/en/a/aa/Magic_the_gathering-card_back.jpg";
            if (type === 'pokemon') backSrc = "https://tcg.pokemon.com/assets/img/global/tcg-card-back-2x.jpg";
            img.src = backSrc; img.style.opacity = "0.3"; 
            img.classList.add('loaded'); // Hide loader
            const loader = img.previousElementSibling;
            if(loader) loader.classList.add('hidden');
        }
    });
</script>
{% endblock %}