{% extends "base.html" %}

{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="fw-bold">Inventory Management</h1>
        <div>
            <form action="{{ url_for('sync_db') }}" method="POST" class="d-inline me-2">
                <button type="submit" class="btn btn-outline-warning" title="Fetch latest cards from PokeAPI">
                    🔄 Sync DB <span class="badge bg-secondary rounded-pill">{{ cache_count }}</span>
                </button>
            </form>
            
            <a href="{{ url_for('sales') }}" class="btn btn-outline-success me-2">💰 Sales History</a>
            <a href="{{ url_for('profile') }}" class="btn btn-outline-primary">👤 Public Profile</a>
        </div>
    </div>

    {% with messages = get_flashed_messages() %}
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-info alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="accordion shadow-sm mb-4" id="adminTools">
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAdd">
                    ➕ Manually Add Card
                </button>
            </h2>
            <div id="collapseAdd" class="accordion-collapse collapse" data-bs-parent="#adminTools">
                <div class="accordion-body">
                    <form action="{{ url_for('add_card') }}" method="POST" class="row g-3">
                        
                        <div class="col-md-12 mb-2 position-relative">
                            <label class="form-label text-primary fw-bold">🔎 Search & Auto-Fill (Type 3+ letters)</label>
                            <input type="text" id="liveSearch" class="form-control" placeholder="Start typing (e.g. 'Charizard Base')..." autocomplete="off">
                            <div id="searchResults" class="list-group position-absolute w-100 shadow" style="z-index: 1000; display:none;"></div>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Card Name</label>
                            <input type="text" id="inputName" name="card_name" class="form-control" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Set Name</label>
                            <input type="text" id="inputSet" name="set_name" class="form-control" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Card #</label>
                            <input type="text" id="inputNumber" name="card_number" class="form-control">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Game</label>
                            <select name="game" class="form-select">
                                <option value="Pokemon TCG" selected>Pokemon</option>
                                <option value="Magic: The Gathering">Magic</option>
                                <option value="One Piece">One Piece</option>
                                <option value="Lorcana">Lorcana</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Price ($)</label>
                            <input type="number" step="0.01" name="price" class="form-control">
                        </div>
                        
                        <input type="hidden" id="inputImage" name="image_url">

                        <div class="col-md-2">
                            <label class="form-label">Quantity</label>
                            <input type="number" name="quantity" value="1" class="form-control">
                        </div>
                        
                        <div class="col-md-3 d-flex align-items-end">
                             <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="firstEdToggle" name="is_first_edition">
                                <label class="form-check-label fw-bold" for="firstEdToggle">✨ 1st Edition</label>
                            </div>
                        </div>
                        
                        <div class="col-md-3 d-flex align-items-end">
                            <div class="form-check form-switch mb-2">
                                <input class="form-check-input" type="checkbox" id="gradedToggle" name="is_graded">
                                <label class="form-check-label fw-bold text-primary" for="gradedToggle">Graded / Slabbed?</label>
                            </div>
                        </div>

                        <div id="gradedFields" class="row g-3 d-none border-start border-3 border-primary ms-1 bg-body-tertiary p-2 rounded mt-2">
                            <div class="col-md-3">
                                <label class="form-label">Company</label>
                                <select name="grading_company" class="form-select">
                                    <option value="PSA">PSA</option>
                                    <option value="CGC">CGC</option>
                                    <option value="TAG">TAG</option>
                                    <option value="BGS">BGS</option>
                                    <option value="SGC">SGC</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Grade</label>
                                <input type="text" name="grade" class="form-control" placeholder="e.g. 10">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Cert Number</label>
                                <input type="text" name="cert_number" class="form-control" placeholder="Optional">
                            </div>
                        </div>

                        <div class="col-12 text-end mt-3">
                            <button type="submit" class="btn btn-primary">Add Card</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePaste">
                    📋 Paste Import
                </button>
            </h2>
            <div id="collapsePaste" class="accordion-collapse collapse" data-bs-parent="#adminTools">
                <div class="accordion-body">
                    <form action="{{ url_for('paste_import') }}" method="POST">
                        <textarea name="paste_data" class="form-control mb-2" rows="5" placeholder="Qty Name [Set] #Num"></textarea>
                        <button type="submit" class="btn btn-success">Import</button>
                    </form>
                </div>
            </div>
        </div>
         <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCSV">
                    📂 Upload CSV
                </button>
            </h2>
            <div id="collapseCSV" class="accordion-collapse collapse" data-bs-parent="#adminTools">
                <div class="accordion-body">
                    <form action="{{ url_for('upload_csv') }}" method="POST" enctype="multipart/form-data">
                        <input type="file" name="file" class="form-control mb-2" required>
                        <button class="btn btn-dark" type="submit">Upload</button>
                    </form>
                </div>
            </div>
        </div>
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSettings">
                    ⚙️ Store Settings
                </button>
            </h2>
            <div id="collapseSettings" class="accordion-collapse collapse" data-bs-parent="#adminTools">
                <div class="accordion-body">
                    <form action="{{ url_for('update_settings') }}" method="POST">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" name="show_prices" id="showPrices" {% if settings.show_prices %}checked{% endif %}>
                            <label class="form-check-label" for="showPrices">Show Prices to Public</label>
                        </div>
                        <button type="submit" class="btn btn-sm btn-primary mt-2">Save Settings</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm mb-5">
        <div class="card-header py-3">
             <div class="row g-2 align-items-center">
                <div class="col-md-4">
                    <h5 class="mb-0 fw-bold">Inventory (<span id="visibleCount">{{ inventory|length }}</span>)</h5>
                </div>
                <div class="col-md-8">
                     <div class="row g-2">
                        <div class="col-12 col-md-4"><input type="text" id="adminSearch" class="form-control form-control-sm" placeholder="Search..."></div>
                        <div class="col-6 col-md-3"><select id="filterGame" class="form-select form-select-sm"><option value="">All Games</option></select></div>
                        <div class="col-6 col-md-3"><select id="filterSet" class="form-select form-select-sm"><option value="">All Sets</option></select></div>
                        <div class="col-6 col-md-2">
                            <select id="sortInventory" class="form-select form-select-sm">
                                <option value="newest">Newest</option>
                                <option value="price-desc">High $</option>
                                <option value="name-asc">A-Z</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card-body p-0">
            <form method="POST" action="{{ url_for('bulk_actions') }}" id="bulkForm">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0 align-middle">
                        <thead>
                            <tr>
                                <th style="width:40px;"><input type="checkbox" class="form-check-input" id="selectAll"></th>
                                <th>Card Name</th>
                                <th>Set</th>
                                <th>Game</th>
                                <th>Cond</th>
                                <th>Price</th>
                                <th>Qty</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryBody">
                            {% for card in inventory %}
                            <tr class="inventory-row" data-name="{{ card.card_name|lower }}" data-set="{{ card.set_name }}" data-game="{{ card.game }}" data-price="{{ card.price }}">
                                <td class="text-center"><input type="checkbox" class="form-check-input card-checkbox" name="card_ids" value="{{ card.id }}"></td>
                                <td>
                                    <span class="fw-bold">{{ card.card_name }}</span>
                                    {% if card.is_first_edition %}
                                        <span class="badge bg-warning text-dark border border-dark ms-1" style="font-size:0.6em;">1st Ed</span>
                                    {% endif %}
                                    {% if card.grading_company %}
                                        <span class="badge bg-danger rounded-pill ms-1">{{ card.grading_company }} {{ card.grade }}</span>
                                    {% endif %}
                                </td>
                                <td><small class="text-muted">{{ card.set_name }}</small></td>
                                <td><small class="text-muted">{{ card.game }}</small></td>
                                <td>{{ card.condition }}</td>
                                <td class="text-success fw-bold">${{ "%.2f"|format(card.price) }}</td>
                                <td>{{ card.quantity }}</td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#editModal{{ card.id }}">✏️</button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </form>
        </div>
    </div>
    
    <div id="bulkActionBar" class="fixed-bottom bg-dark text-white p-3 shadow-lg d-none">
        <div class="container d-flex justify-content-between">
            <div><span class="badge bg-primary me-2"><span id="selectedCount">0</span> Selected</span> <button class="btn btn-sm btn-outline-light" onclick="clearSelection()">Cancel</button></div>
            <div class="d-flex">
                <input type="number" form="bulkForm" name="discount" class="form-control form-control-sm me-2" placeholder="Disc %" style="width:80px;">
                <button type="submit" form="bulkForm" name="action" value="sell" class="btn btn-success me-2">Sell</button>
                <button type="submit" form="bulkForm" name="action" value="delete" class="btn btn-danger">Delete</button>
            </div>
        </div>
    </div>

    {% for card in inventory %}
    <div class="modal fade" id="editModal{{ card.id }}" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit {{ card.card_name }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form action="{{ url_for('update_card', id=card.id) }}" method="POST">
                        <input type="hidden" name="action" value="update_details">
                        <div class="row g-2">
                            <div class="col-6">Price <input type="number" step="0.01" name="price" class="form-control" value="{{ card.price }}"></div>
                            <div class="col-6">Qty <input type="number" name="quantity" class="form-control" value="{{ card.quantity }}"></div>
                        </div>
                        <button class="btn btn-primary mt-3 w-100">Save</button>
                    </form>
                    <hr>
                    <form action="{{ url_for('update_card', id=card.id) }}" method="POST" onsubmit="return confirm('Delete?')">
                        <input type="hidden" name="action" value="delete">
                        <button class="btn btn-danger w-100">Delete</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}

</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // --- LIVE SEARCH LOGIC ---
    const searchInput = document.getElementById('liveSearch');
    const resultsDiv = document.getElementById('searchResults');
    const inputName = document.getElementById('inputName');
    const inputSet = document.getElementById('inputSet');
    const inputNumber = document.getElementById('inputNumber');
    const inputImage = document.getElementById('inputImage');
    
    let debounceTimer;

    if(searchInput) {
        searchInput.addEventListener('input', function() {
            clearTimeout(debounceTimer);
            const query = this.value;
            
            if (query.length < 3) {
                resultsDiv.style.display = 'none';
                return;
            }
            
            debounceTimer = setTimeout(() => {
                fetch(`/api/search_reference?q=${encodeURIComponent(query)}`)
                    .then(r => r.json())
                    .then(data => {
                        resultsDiv.innerHTML = '';
                        if(data.length > 0) {
                            data.forEach(item => {
                                const a = document.createElement('a');
                                a.className = 'list-group-item list-group-item-action';
                                a.style.cursor = 'pointer';
                                a.innerHTML = `<strong>${item.name}</strong> <small class='text-muted'>${item.set} #${item.number}</small>`;
                                a.onclick = function() {
                                    inputName.value = item.name;
                                    inputSet.value = item.set;
                                    inputNumber.value = item.number;
                                    inputImage.value = item.image || '';
                                    resultsDiv.style.display = 'none';
                                    searchInput.value = ''; // Clear search box
                                };
                                resultsDiv.appendChild(a);
                            });
                            resultsDiv.style.display = 'block';
                        } else {
                            resultsDiv.style.display = 'none';
                        }
                    });
            }, 300);
        });

        // Hide dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target !== searchInput && e.target !== resultsDiv) {
                resultsDiv.style.display = 'none';
            }
        });
    }

    // --- GRADED TOGGLE ---
    const gradedToggle = document.getElementById('gradedToggle');
    const gradedFields = document.getElementById('gradedFields');
    if (gradedToggle) {
        gradedToggle.addEventListener('change', function() {
            if(this.checked) {
                gradedFields.classList.remove('d-none');
                gradedFields.classList.add('d-flex');
            } else {
                gradedFields.classList.add('d-none');
                gradedFields.classList.remove('d-flex');
            }
        });
    }

    // --- STANDARD TABLE FILTERING (Existing Logic) ---
    // (Preserved from previous versions for basic filtering)
    const rows = Array.from(document.querySelectorAll('.inventory-row'));
    const adminSearch = document.getElementById('adminSearch');
    
    if(adminSearch) {
        adminSearch.addEventListener('keyup', function() {
            const val = this.value.toLowerCase();
            rows.forEach(row => {
                const text = row.dataset.name + " " + row.dataset.set;
                row.style.display = text.includes(val) ? '' : 'none';
            });
        });
    }
    
    // --- BULK UI ---
    const checkboxes = document.querySelectorAll('.card-checkbox');
    const bulkBar = document.getElementById('bulkActionBar');
    const selCount = document.getElementById('selectedCount');
    
    function updateBulk() {
        const c = document.querySelectorAll('.card-checkbox:checked').length;
        selCount.innerText = c;
        if(c > 0) bulkBar.classList.remove('d-none');
        else bulkBar.classList.add('d-none');
    }
    
    checkboxes.forEach(cb => cb.addEventListener('change', updateBulk));
    window.clearSelection = function() {
        checkboxes.forEach(cb => cb.checked = false);
        updateBulk();
    }
});
</script>
{% endblock %}