{% extends "base.html" %}

{% block title %}{{ owner.username }}'s Binder{% endblock %}

{% block styles %}
<style>
    .binder-grid { 
        display: grid; 
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); 
        gap: 24px; 
        padding: 24px; 
    }
    .card-slot { 
        border: none;
        border-radius: 12px; 
        overflow: hidden; 
        background: #2c3e50; /* Dark background for empty space */
        text-align: center; 
        position: relative; 
        aspect-ratio: 2.5/3.5; 
        transition: transform 0.2s, box-shadow 0.2s;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    .card-slot:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        z-index: 10;
    }
    .card-image {
        width: 100%;
        height: 100%;
        object-fit: contain; /* Ensures the whole card is visible */
        position: relative;
        z-index: 1;
    }
    /* Loading Placeholder Animation */
    .skeleton-loader {
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, #34495e 25%, #2c3e50 50%, #34495e 75%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
        position: absolute;
        top: 0; left: 0;
        z-index: 2;
    }
    @keyframes loading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }
    
    .price-badge { 
        position: absolute; 
        top: 10px; 
        right: 10px; 
        background: #27ae60; 
        color: white; 
        padding: 4px 8px; 
        border-radius: 4px; 
        font-size: 0.85rem; 
        font-weight: bold; 
        z-index: 5;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .info-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        background: rgba(0, 0, 0, 0.85);
        color: white;
        padding: 8px;
        text-align: center;
        z-index: 5;
        backdrop-filter: blur(4px);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid p-0">
    <nav class="navbar navbar-dark bg-dark mb-0 shadow-sm sticky-top">
        <div class="container-fluid">
            <span class="navbar-brand h1 mb-0">{{ owner.username }}'s Binder</span>
            <div>
                <span class="badge bg-secondary me-2">{{ inventory|length }} Cards</span>
                <a href="{{ url_for('user_storefront', username=owner.username) }}" class="btn btn-sm btn-outline-light">List View</a>
            </div>
        </div>
    </nav>

    <div class="binder-grid">
        {% for card in inventory %}
        <div class="card-slot" 
             data-game="{{ card.game }}" 
             data-name="{{ card.card_name }}" 
             data-set="{{ card.set_name }}" 
             data-number="{{ card.card_number }}">
            
            <!-- Price (Always Visible) -->
            {% if show_prices %}
            <div class="price-badge">${{ "%.2f"|format(card.price) }}</div>
            {% endif %}

            <!-- Loader -->
            <div class="skeleton-loader"></div>
            
            <!-- Image -->
            <img class="card-image d-none" alt="{{ card.card_name }}" loading="lazy">
            
            <!-- Info (Always Visible at bottom) -->
            <div class="info-overlay">
                <div class="fw-bold text-truncate" style="font-size: 0.9rem;">{{ card.card_name }}</div>
                <div class="small text-muted" style="font-size: 0.75rem;">{{ card.set_name }} â€¢ {{ card.condition }}</div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const cards = document.querySelectorAll('.card-slot');
        
        cards.forEach(card => {
            const gameRaw = card.dataset.game || "";
            const game = gameRaw.toLowerCase();
            const name = card.dataset.name;
            const imgEl = card.querySelector('img');
            const loader = card.querySelector('.skeleton-loader');

            // Log for debugging
            // console.log(`Processing: ${name} (${game})`);

            let apiUrl = "";

            // --- MAGIC: THE GATHERING STRATEGY ---
            if (game.includes('magic') || game.includes('mtg')) {
                apiUrl = `https://api.scryfall.com/cards/named?fuzzy=${encodeURIComponent(name)}&format=image`;
                loadImage(imgEl, loader, apiUrl);
            }
            
            // --- POKEMON STRATEGY ---
            else if (game.includes('pokemon') || game.includes('pkmn') || game.includes('ptcg')) {
                // Remove variants like "(Holo)" for better search results
                const cleanName = name.split('(')[0].trim();
                
                fetch(`https://api.tcgdex.net/v2/en/cards?name=${encodeURIComponent(cleanName)}`)
                    .then(r => r.json())
                    .then(data => {
                        if(data && data.length > 0) {
                            // Try to find one with an image
                            const match = data.find(c => c.image) || data[0];
                            if(match && match.image) {
                                loadImage(imgEl, loader, match.image + "/high.webp");
                            } else {
                                loadFallback(imgEl, loader, 'pokemon');
                            }
                        } else {
                            loadFallback(imgEl, loader, 'pokemon');
                        }
                    })
                    .catch((e) => {
                        console.error("Pokemon API Error:", e);
                        loadFallback(imgEl, loader, 'pokemon');
                    });
            } 
            
            // --- ONE PIECE STRATEGY ---
            else if (game.includes('one') || game.includes('piece') || game.includes('opcg')) {
                // One Piece API is limited, using fallback for now
                loadFallback(imgEl, loader, 'onepiece');
            }

            // --- UNKNOWN GAME ---
            else {
                // Try Scryfall anyway if it looks vaguely Magic-like, otherwise fallback
                loadFallback(imgEl, loader, 'default');
            }
        });

        function loadImage(img, loader, src) {
            img.src = src;
            img.onload = () => {
                loader.classList.add('d-none');
                img.classList.remove('d-none');
            };
            img.onerror = () => {
                console.warn("Failed to load image:", src);
                loadFallback(img, loader, 'default');
            };
        }

        function loadFallback(img, loader, type) {
            // Specific card backs for realism
            let backSrc = "";
            if (type === 'pokemon') {
                backSrc = "https://tcg.pokemon.com/assets/img/global/tcg-card-back-2x.jpg";
            } else if (type === 'onepiece') {
                backSrc = "https://en.onepiece-cardgame.com/images/common/card_back.jpg"; // Placeholder
            } else {
                // Default to Magic
                backSrc = "https://upload.wikimedia.org/wikipedia/en/a/aa/Magic_the_gathering-card_back.jpg";
            }

            img.src = backSrc;
            img.style.opacity = "0.5"; // Dim the card back so text is readable
            loader.classList.add('d-none');
            img.classList.remove('d-none');
        }
    });
</script>
{% endblock %}