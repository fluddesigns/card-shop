{% extends "base.html" %}

{% block title %}{{ owner.username }}'s Binder{% endblock %}

{% block styles %}
<style>
    .binder-grid { 
        display: grid; 
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); 
        gap: 24px; 
        padding: 24px; 
    }
    .card-slot { 
        border: none;
        border-radius: 12px; 
        overflow: hidden; 
        background: #2c3e50; /* Dark background for empty space */
        text-align: center; 
        position: relative; 
        aspect-ratio: 2.5/3.5; 
        transition: transform 0.2s, box-shadow 0.2s;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    .card-slot:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        z-index: 10;
    }
    .card-image {
        width: 100%;
        height: 100%;
        object-fit: contain;
        position: relative;
        z-index: 1;
        transition: opacity 0.3s;
    }
    /* Loading Placeholder Animation */
    .skeleton-loader {
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, #34495e 25%, #2c3e50 50%, #34495e 75%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
        position: absolute;
        top: 0; left: 0;
        z-index: 2;
    }
    @keyframes loading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }
    
    .price-badge { 
        position: absolute; 
        top: 10px; 
        right: 10px; 
        background: #27ae60; 
        color: white; 
        padding: 4px 8px; 
        border-radius: 4px; 
        font-size: 0.85rem; 
        font-weight: bold; 
        z-index: 5;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .info-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        background: rgba(0, 0, 0, 0.85);
        color: white;
        padding: 8px;
        text-align: center;
        z-index: 5;
        backdrop-filter: blur(4px);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid p-0">
    <nav class="navbar navbar-dark bg-dark mb-0 shadow-sm sticky-top">
        <div class="container-fluid">
            <span class="navbar-brand h1 mb-0">{{ owner.username }}'s Binder</span>
            <div>
                <span class="badge bg-secondary me-2">{{ inventory|length }} Cards</span>
                <a href="{{ url_for('user_storefront', username=owner.username) }}" class="btn btn-sm btn-outline-light">List View</a>
            </div>
        </div>
    </nav>

    <div class="binder-grid">
        {% for card in inventory %}
        <div class="card-slot" 
             data-game="{{ card.game }}" 
             data-name="{{ card.card_name }}" 
             data-set="{{ card.set_name }}" 
             data-number="{{ card.card_number }}">
            
            {% if show_prices %}
            <div class="price-badge">${{ "%.2f"|format(card.price) }}</div>
            {% endif %}

            <div class="skeleton-loader"></div>
            <img class="card-image d-none" alt="{{ card.card_name }}" loading="lazy">
            
            <div class="info-overlay">
                <div class="fw-bold text-truncate" style="font-size: 0.9rem;">{{ card.card_name }}</div>
                <div class="small text-muted" style="font-size: 0.75rem;">{{ card.set_name }}</div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const cards = document.querySelectorAll('.card-slot');
        
        cards.forEach(card => {
            const gameRaw = card.dataset.game || "";
            const game = gameRaw.toLowerCase();
            const name = card.dataset.name;
            const imgEl = card.querySelector('img');
            const loader = card.querySelector('.skeleton-loader');

            // --- MAGIC: THE GATHERING ---
            if (game.includes('magic') || game.includes('mtg')) {
                // FETCH JSON FIRST (Fixes CORB)
                // We ask for the data object, not the image direct
                const apiUrl = `https://api.scryfall.com/cards/named?fuzzy=${encodeURIComponent(name)}`;
                
                fetch(apiUrl)
                    .then(r => {
                        if (!r.ok) throw new Error("Scryfall 404");
                        return r.json();
                    })
                    .then(data => {
                        if (data.image_uris && data.image_uris.normal) {
                            loadImage(imgEl, loader, data.image_uris.normal);
                        } else if (data.card_faces && data.card_faces[0].image_uris) {
                            // Handle double-faced cards
                            loadImage(imgEl, loader, data.card_faces[0].image_uris.normal);
                        } else {
                            loadFallback(imgEl, loader, 'magic');
                        }
                    })
                    .catch(e => {
                        console.warn("MTG Fetch Error:", name, e);
                        loadFallback(imgEl, loader, 'magic');
                    });
            }
            
            // --- POKEMON ---
            else if (game.includes('pokemon') || game.includes('pkmn') || game.includes('ptcg')) {
                const cleanName = name.split('(')[0].trim();
                const query = `https://api.pokemontcg.io/v2/cards?q=name:"${encodeURIComponent(cleanName)}"&pageSize=1`;
                
                fetch(query)
                    .then(r => r.json())
                    .then(data => {
                        if(data && data.data && data.data.length > 0) {
                            const imgUrl = data.data[0].images.small;
                            loadImage(imgEl, loader, imgUrl);
                        } else {
                            loadFallback(imgEl, loader, 'pokemon');
                        }
                    })
                    .catch((e) => {
                        console.error("Pokemon API Error:", e);
                        loadFallback(imgEl, loader, 'pokemon');
                    });
            } 
            
            // --- ONE PIECE ---
            else if (game.includes('one') || game.includes('piece') || game.includes('opcg')) {
                // Fallback immediately for One Piece to avoid stuck loaders
                loadFallback(imgEl, loader, 'onepiece');
            }

            // --- UNKNOWN ---
            else {
                loadFallback(imgEl, loader, 'default');
            }
        });

        function loadImage(img, loader, src) {
            img.src = src;
            img.onload = () => {
                loader.classList.add('d-none');
                img.classList.remove('d-none');
            };
            img.onerror = () => {
                // If the specific image URL fails (rare), show fallback
                loadFallback(img, loader, 'default');
            };
        }

        function loadFallback(img, loader, type) {
            let backSrc = "https://upload.wikimedia.org/wikipedia/en/a/aa/Magic_the_gathering-card_back.jpg";
            if (type === 'pokemon') {
                backSrc = "https://tcg.pokemon.com/assets/img/global/tcg-card-back-2x.jpg";
            } else if (type === 'onepiece') {
                backSrc = "https://en.onepiece-cardgame.com/images/common/card_back.jpg";
            }
            
            img.src = backSrc;
            img.style.opacity = "0.3"; 
            loader.classList.add('d-none');
            img.classList.remove('d-none');
        }
    });
</script>
{% endblock %}