{% extends "base.html" %}

{% block title %}{{ owner.username }}'s Binder{% endblock %}

{% block styles %}
<style>
    .binder-grid { 
        display: grid; 
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); 
        gap: 24px; 
        padding: 24px; 
    }
    .card-slot { 
        border: none;
        border-radius: 12px; 
        overflow: hidden; 
        background: #2c3e50; 
        text-align: center; 
        position: relative; 
        aspect-ratio: 2.5/3.5; 
        transition: transform 0.2s, box-shadow 0.2s;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    .card-slot:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        z-index: 10;
    }
    .card-image {
        width: 100%;
        height: 100%;
        object-fit: contain;
        position: relative;
        z-index: 1;
        transition: opacity 0.3s;
    }
    .skeleton-loader {
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, #34495e 25%, #2c3e50 50%, #34495e 75%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
        position: absolute;
        top: 0; left: 0;
        z-index: 2;
    }
    @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    
    .price-badge { 
        position: absolute; 
        top: 10px; 
        right: 10px; 
        background: #27ae60; 
        color: white; 
        padding: 4px 8px; 
        border-radius: 4px; 
        font-size: 0.85rem; 
        font-weight: bold; 
        z-index: 5;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .info-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        background: rgba(0, 0, 0, 0.85);
        color: white;
        padding: 8px;
        text-align: center;
        z-index: 5;
        backdrop-filter: blur(4px);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid p-0">
    <nav class="navbar navbar-dark bg-dark mb-0 shadow-sm sticky-top">
        <div class="container-fluid">
            <span class="navbar-brand h1 mb-0">{{ owner.username }}'s Binder</span>
            <div>
                <span class="badge bg-secondary me-2">{{ inventory|length }} Cards</span>
                <a href="{{ url_for('user_storefront', username=owner.username) }}" class="btn btn-sm btn-outline-light">List View</a>
            </div>
        </div>
    </nav>

    <div class="binder-grid">
        {% for card in inventory %}
        <div class="card-slot" 
             data-game="{{ card.game }}" 
             data-name="{{ card.card_name }}" 
             data-set="{{ card.set_name }}" 
             data-number="{{ card.card_number }}">
            
            {% if show_prices %}
            <div class="price-badge">${{ "%.2f"|format(card.price) }}</div>
            {% endif %}

            <div class="skeleton-loader"></div>
            <img class="card-image d-none" alt="{{ card.card_name }}" loading="lazy">
            
            <div class="info-overlay">
                <div class="fw-bold text-truncate" style="font-size: 0.9rem;">{{ card.card_name }}</div>
                <div class="small text-muted" style="font-size: 0.75rem;">{{ card.set_name }}</div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const queue = Array.from(document.querySelectorAll('.card-slot'));
        const RATE_LIMIT_DELAY = 150; 
        processNext();

        function processNext() {
            if (queue.length === 0) return;
            const card = queue.shift();
            fetchCardImage(card).finally(() => { setTimeout(processNext, RATE_LIMIT_DELAY); });
        }

        async function fetchCardImage(card) {
            const game = (card.dataset.game || "").toLowerCase();
            const name = card.dataset.name;
            const set = (card.dataset.set || "").trim();
            const imgEl = card.querySelector('img');
            const loader = card.querySelector('.skeleton-loader');

            try {
                if (game.includes('magic') || game.includes('mtg')) {
                    let query = `https://api.scryfall.com/cards/search?q=name:"${encodeURIComponent(name)}"`;
                    if (set && set.length < 6) query += `+set:${set}`;
                    
                    let r = await fetch(query);
                    if (!r.ok) r = await fetch(`https://api.scryfall.com/cards/named?fuzzy=${encodeURIComponent(name)}`);
                    
                    if(!r.ok) throw new Error("404");
                    const d = await r.json();
                    
                    let target = d;
                    if(d.data && d.data.length > 0) target = d.data[0];

                    if (target.image_uris) loadImage(imgEl, loader, target.image_uris.normal);
                    else if (target.card_faces) loadImage(imgEl, loader, target.card_faces[0].image_uris.normal);
                    else throw new Error("No Img");
                } 
                else if (game.includes('pokemon') || game.includes('pkmn')) {
                    const cleanName = name.split('(')[0].trim();
                    let query = `https://api.pokemontcg.io/v2/cards?q=name:"${encodeURIComponent(cleanName)}"`;
                    if (set) query += ` set.name:"${encodeURIComponent(set)}"`;
                    
                    let r = await fetch(query);
                    let d = await r.json();
                    
                    if (!d.data || d.data.length === 0) {
                         r = await fetch(`https://api.pokemontcg.io/v2/cards?q=name:"${encodeURIComponent(cleanName)}"`);
                         d = await r.json();
                    }
                    
                    if (d.data && d.data.length > 0) loadImage(imgEl, loader, d.data[0].images.small);
                    else throw new Error("No Img");
                } 
                else { loadFallback(imgEl, loader, 'default'); }
            } catch (error) {
                loadFallback(imgEl, loader, game.includes('pokemon') ? 'pokemon' : 'default');
            }
        }

        function loadImage(img, loader, src) {
            img.src = src;
            img.onload = () => { loader.classList.add('d-none'); img.classList.remove('d-none'); };
            img.onerror = () => { loadFallback(img, loader, 'default'); };
        }

        function loadFallback(img, loader, type) {
            let backSrc = "https://upload.wikimedia.org/wikipedia/en/a/aa/Magic_the_gathering-card_back.jpg";
            if (type === 'pokemon') backSrc = "https://tcg.pokemon.com/assets/img/global/tcg-card-back-2x.jpg";
            img.src = backSrc; img.style.opacity = "0.3"; 
            loader.classList.add('d-none'); img.classList.remove('d-none');
        }
    });
</script>
{% endblock %}