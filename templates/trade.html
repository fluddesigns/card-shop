<!DOCTYPE html>
<html lang="en">
<head>
    <title>Trade Equalizer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f0f2f5; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        .trade-container { flex: 1; display: flex; overflow: hidden; }
        .trade-side { flex: 1; display: flex; flex-direction: column; padding: 10px; border-right: 1px solid #dee2e6; }
        .trade-side:last-child { border-right: none; }
        .inventory-list { flex: 1; overflow-y: auto; background: white; border: 1px solid #ced4da; border-radius: 5px; margin-bottom: 10px; }
        .cart-list { height: 30%; overflow-y: auto; background: #e9ecef; border: 1px solid #ced4da; border-radius: 5px; padding: 5px; }
        .item-row { padding: 6px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .item-row:hover { background: #f8f9fa; }
        .item-row.selected { background: #e2e6ea; }
        .total-box { text-align: center; font-weight: bold; font-size: 1.2rem; padding: 10px; background: #343a40; color: white; border-radius: 5px; }
        .diff-bar { text-align: center; padding: 10px; font-weight: bold; background: #fff3cd; color: #856404; }
        /* Mobile Stack */
        @media (max-width: 768px) {
            .trade-container { flex-direction: column; }
            .trade-side { border-right: none; border-bottom: 1px solid #dee2e6; }
            .cart-list { height: 150px; }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark px-3 flex-shrink-0">
        <span class="navbar-brand mb-0 h1">⚖️ Trade Equalizer</span>
        <a href="{{ url_for('index') }}" class="btn btn-sm btn-outline-light">Exit</a>
    </nav>

    <div class="diff-bar" id="diffDisplay">Difference: $0.00</div>

    <div class="trade-container">
        <!-- Left Trader -->
        <div class="trade-side">
            <select class="form-select mb-2" id="userSelect1" onchange="loadInventory(1)">
                <option value="">Select Trader A...</option>
                {% for user in users %}
                <option value="{{ user.username }}">{{ user.username }}</option>
                {% endfor %}
            </select>
            <input type="text" class="form-control mb-2" id="search1" placeholder="Search cards..." onkeyup="filterInventory(1)">
            <div class="inventory-list" id="invList1"></div>
            <div class="cart-list" id="cart1"></div>
            <div class="total-box mt-2" id="total1">$0.00</div>
        </div>

        <!-- Right Trader -->
        <div class="trade-side">
            <select class="form-select mb-2" id="userSelect2" onchange="loadInventory(2)">
                <option value="">Select Trader B...</option>
                {% for user in users %}
                <option value="{{ user.username }}">{{ user.username }}</option>
                {% endfor %}
            </select>
            <input type="text" class="form-control mb-2" id="search2" placeholder="Search cards..." onkeyup="filterInventory(2)">
            <div class="inventory-list" id="invList2"></div>
            <div class="cart-list" id="cart2"></div>
            <div class="total-box mt-2" id="total2">$0.00</div>
        </div>
    </div>

    <script>
        let inventories = {1: [], 2: []};
        let carts = {1: [], 2: []};

        async function loadInventory(side) {
            const username = document.getElementById(`userSelect${side}`).value;
            const listDiv = document.getElementById(`invList${side}`);
            listDiv.innerHTML = '<div class="p-2 text-muted">Loading...</div>';
            
            if(!username) {
                listDiv.innerHTML = '';
                inventories[side] = [];
                renderInventory(side);
                return;
            }

            try {
                // Fetch from the new API endpoint
                const response = await fetch(`/api/inventory/${username}`);
                const cards = await response.json();
                
                inventories[side] = cards;
                renderInventory(side);
            } catch (e) {
                listDiv.innerHTML = '<div class="p-2 text-danger">Error loading inventory. Ensure User exists and API is reachable.</div>';
                console.error(e);
            }
        }

        function renderInventory(side) {
            const listDiv = document.getElementById(`invList${side}`);
            const query = document.getElementById(`search${side}`).value.toLowerCase();
            const cards = inventories[side];
            
            let html = '';
            cards.forEach(card => {
                // Simple search filter
                if (card.card_name.toLowerCase().includes(query) || card.set_name.toLowerCase().includes(query)) {
                    html += `
                    <div class="item-row" onclick="addToCart(${side}, ${card.id})">
                        <div>
                            <div class="fw-bold small">${card.card_name}</div>
                            <div class="text-muted" style="font-size: 0.75rem">${card.set_name} (${card.condition})</div>
                        </div>
                        <div class="text-success fw-bold">$${card.price.toFixed(2)}</div>
                    </div>`;
                }
            });
            
            if(html === '') html = '<div class="p-2 text-muted small">No cards found.</div>';
            listDiv.innerHTML = html;
        }

        function filterInventory(side) {
            renderInventory(side);
        }

        function addToCart(side, cardId) {
            const card = inventories[side].find(c => c.id === cardId);
            if(card) {
                carts[side].push(card);
                renderCart(side);
                updateTotals();
            }
        }

        function removeFromCart(side, index) {
            carts[side].splice(index, 1);
            renderCart(side);
            updateTotals();
        }

        function renderCart(side) {
            const cartDiv = document.getElementById(`cart${side}`);
            let html = '';
            carts[side].forEach((item, index) => {
                html += `
                <div class="item-row" onclick="removeFromCart(${side}, ${index})">
                    <span class="small">${item.card_name}</span>
                    <span class="text-success small fw-bold">$${item.price.toFixed(2)}</span>
                </div>`;
            });
            if(carts[side].length === 0) html = '<div class="text-muted small text-center p-2">Empty Trade Pile</div>';
            cartDiv.innerHTML = html;
        }

        function updateTotals() {
            const total1 = carts[1].reduce((sum, item) => sum + item.price, 0);
            const total2 = carts[2].reduce((sum, item) => sum + item.price, 0);
            
            document.getElementById('total1').innerText = '$' + total1.toFixed(2);
            document.getElementById('total2').innerText = '$' + total2.toFixed(2);
            
            const diff = total1 - total2;
            const diffDisplay = document.getElementById('diffDisplay');
            
            if (Math.abs(diff) < 0.01) {
                diffDisplay.innerText = "Even Trade";
                diffDisplay.style.background = "#d1e7dd";
                diffDisplay.style.color = "#0f5132";
            } else {
                const winner = diff > 0 ? "Trader A" : "Trader B";
                diffDisplay.innerText = `${winner} needs to add $${Math.abs(diff).toFixed(2)}`;
                diffDisplay.style.background = "#fff3cd";
                diffDisplay.style.color = "#856404";
            }
        }
    </script>
</body>
</html>
